---
title: "DS 6372 Project 1"
output: html_document
---
# World Health Organization

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(ggplot2)
library(plyr)
library(dplyr)
library(GGally)
library(tidyverse)
library(naniar)
library(zoom)
library(MASS)
library(plotly)
library(ggpubr)
library(onewaytests)
library(glmnet)
library(randomForest)
```

## Context

Although there have been lot of studies undertaken in the past on factors affecting life expectancy considering demographic variables, income composition and mortality rates. It was found that affect of immunization and human development index was not taken into account in the past. Also, some of the past research was done considering multiple linear regression based on data set of one year for all the countries. Hence, this gives motivation to resolve both the factors stated previously by formulating a regression model based on mixed effects model and multiple linear regression while considering data from a period of 2000 to 2015 for all the countries. Important immunization like Hepatitis B, Polio and Diphtheria will also be considered. In a nutshell, this study will focus on immunization factors, mortality factors, economic factors, social factors and other health related factors as well. Since the observations this dataset are based on different countries, it will be easier for a country to determine the predicting factor which is contributing to lower value of life expectancy. This will help in suggesting a country which area should be given importance in order to efficiently improve the life expectancy of its population.

*Column Names: Meanings*

- Year: Year
- Status: Developed or Developing status
- Life expectancy: Life Expectancy in age
- Adult Mortality: Adult Mortality Rates of both sexes (probability of dying between 15 and 60 years per 1000 population)
- infant deaths: Number of Infant Deaths per 1000 population
- Alcohol: Alcohol, recorded per capita (15+) consumption (in litres of pure alcohol)
- percentage expenditure: Expenditure on health as a percentage of Gross Domestic Product per capita(%)
- Hepatitis B: Hepatitis B (HepB) immunization coverage among 1-year-olds (%)
- Measles:Measles - number of reported cases per 1000 population
- BMI: Average Body Mass Index of entire population
- Polio: Polio (Pol3) immunization coverage among 1-year-olds (%)
- Total expenditure: General government expenditure on health as a percentage of total government expenditure (%)
- Diphtheria: Diphtheria tetanus toxoid and pertussis (DTP3) immunization coverage among 1-year-olds (%)
- HIV/AIDS: Deaths per 1 000 live births HIV/AIDS (0-4 years)
- GDP: Gross Domestic Product per capita (in USD)
- Population: Population of the country
- thinness 1-19 years: Prevalence of thinness among children and adolescents for Age 10 to 19 (%)
- thinness 5-9 years: Prevalence of thinness among children for Age 5 to 9(%)
- income composition of resources: Human Development Index in terms of income composition of resources (index ranging from 0 to 1)
- schooling: Number of years of Schooling(years)


```{r}

# creates all required resisual plots

    residual.plots <- function (model) {
      par(mfrow = c(2, 3))
      p1 <- plot(model)
      p2 <- plot(model, 3)
      p3 <- plot(model, 4)
      return(list(p1, p2, p3))
    }

```

#### ETL

Prior to running the models, the data was manipulated to remove nulls, adjusted for inconsistencies in the data, and eliminating columns that were not required.

1. Removing Nan values
  This proved to have higher R^2 values and lower number of variables that were considered to be significant. While the model appears to have a better fit, this is not the ideal scenario since ~30% of the data was lost in this process.

2. Filter out percentage.expenditure greather than 100. 
  This caused additional values to be considered in significant. This is filtered considering that a population cannot spend more than 100% of their GDP on health care.

3. Replace Nan with means
  This allows for all data to be conserved.

```{r}
# Reading datafile
      Life_Expectancy_Df <- read.csv("../data\ /Life\ Expectancy\ Data.csv", header=TRUE)
      Life_Expectancy_Df_2014 <- Life_Expectancy_Df %>% filter(Year == 2014) # Keeping only 2014 data as per requirement
      gg_miss_var(Life_Expectancy_Df_2014)

# remove Nan rows
    # dummy code (developing = 1, developed = 0)
      values <- c(0, 1)
      Life_Expectancy_Df_2014$Status_dc <- values[Life_Expectancy_Df_2014$Status]
      Life_Expectancy_Df_2014_dc <- Life_Expectancy_Df_2014[,c(4:23)]
    # remove nulls
      df1_no.nan <- na.omit(Life_Expectancy_Df_2014_dc) 
      
    # drop population column
      df1_drop <- subset(Life_Expectancy_Df_2014_dc, select = -c(Population, GDP) )
      df1_drop <- na.omit(df1_drop) 
      
# replace missing data wtih averages
      df_means <- Life_Expectancy_Df_2014
      for(i in 1:ncol(df_means)){
        df_means[is.na(df_means[,i]), i] <- mean(df_means[,i], na.rm = TRUE)
      }
      sum(is.na(df_means))
      df1_complete <- df_means[,c(3:23)]
      #df_means.condense <- df_means.condense %>% filter(df_means.condense$percentage.expenditure < 100)
```

#### 1. Does various predicting factors which has been chosen initially really affect the Life expectancy? What are the predicting variables actually affecting the life expectancy?

After running multiple regression models (forward, backward, and stepwise), it was determined that the following variables are the predictors that are statically significant in regards to life expectancy. 

Variables
StatusDeveloping                -1.923054   
Adult.Mortality                 -0.016917   
infant.deaths                    0.086154   
under.five.deaths               -0.067124   
Total.expenditure                0.250440   
Diphtheria                       0.028511   
HIV.AIDS                        -1.020423   
Income.composition.of.resources 27.870308

While the other variables intuitively may appear significant, the variables above are the predictors that have significant impact according to the regression models. interestingly enough, all models resulted in the same variables being returned. 

```{r}

  # Fit the full model 
    full.model <- lm(Life.expectancy ~., data = df1_complete)
    # Stepwise regression model
      step.model <- stepAIC(full.model, direction = "both", 
                        trace = FALSE)
      summary(step.model)
    # forward regression model
      foward.model <- stepAIC(full.model, direction = "forward", 
                        trace = FALSE)
      summary(foward.model)
    # backward regression model
      backward.model <- stepAIC(full.model, direction = "backward", 
                        trace = FALSE)
      summary(backward.model)
      
# assumptions testing
par(mfrow = c(2, 2))
plot(full.model)

```

#### 2.Should a country having a lower life expectancy value(<65) increase its healthcare expenditure in order to improve its average lifespan?

```{r}


```

#### 3.How does Infant and Adult mortality rates affect life expectancy?

```{r}



```

#### 4.Does Life Expectancy has positive or negative correlation with eating habits, lifestyle, exercise, smoking, drinking alcohol etc.

```{r}



```

#### 5.What is the impact of schooling on the lifespan of humans?

Life expectancy and schooling have a positive linear relationship. Despite not being significant in the full model, schooling is a significant indicator when its modeled as a singly linear regression. 

The summary statistics shows high significants of alpha less than 0.001. The relationship can be modeled by the regression below:

                          life expectancy = 38.72 + 2.51(schooling)

We notice that as schooling increases by a year, life expectancy is increased by 2.5 years, with no schooling having a life expectancy of 38.72 years.

```{r}

# linear model
school.model <- lm(Life.expectancy ~Schooling, data = df1_complete)

# summary statistics of schooling vs. life expectancy
summary(school.model)

# graph the regession 
p.school <- ggplot(Life_Expectancy_Df_2014, aes(x =  Schooling , y = Life.expectancy )) +  geom_point() + stat_smooth(method = "lm", col = "red")
ggplotly(p.school)

# assumptions testing
par(mfrow = c(2, 2))
plot(school.model)

```

#### 6.Does Life Expectancy have positive or negative relationship with drinking alcohol?


Life expectancy has a slight positive increase with alcohol consumption. 

                          life expectancy = 67.11 + 1.11(Alcohol)

Notice that as alcohol consumption incrases, life expectancy incrases by 1.11 years, starting at 67.11 years expected if no alcohol is consumed. 

This is a bit counter intuitive considering the knowledge that alcohol is not considered to be healthy and many studies suggest that alcohol could shorten life spans. Keeping this in coonsideration, additional studies may need to be conducted. 
```{r}
# linear model
alcohol.model <- lm(Life.expectancy ~Alcohol, data = df1_complete)

# summary statistics of schooling vs. life expectancy
summary(alcohol.model)

# graph the regession 
p.alcohol <- ggplot(Life_Expectancy_Df_2014, aes(x =  Alcohol , y = Life.expectancy )) +  geom_point() + stat_smooth(method = "lm", col = "red")
ggplotly(p.alcohol)

par(mfrow = c(2, 2))
plot(alcohol.model)

```

#### 7.Do densely populated countries tend to have lower life expectancy?
Initally, there is a significant outlier that skews the data dramatically. Once removed, we noticed the sloped droped by nearly 50%. Considering that there is the possibility of having significanlt high populations, it has been concluded to keep the data point in.

                          life expectancy = 70.58 - 2.65(Population)

Notice that as the population in a country increases, life expectancy decreases by 2.65 years, starting at 70.58 years expected if there is no population. In this scenario, the intercept independent of the slope has no logical reasoning considering that no population would result in no life expectancy.

```{r}

# linear model
popultion.model <- lm(Life.expectancy ~Population, data = df1_complete)

# summary statistics of schooling vs. life expectancy
summary(popultion.model)

# graph the regession 
p.population <- ggplot(Life_Expectancy_Df_2014, aes(x =  Population , y = Life.expectancy )) +  geom_point() + stat_smooth(method = "lm", col = "red")
ggplotly(p.population)

# assumptions testing
par(mfrow = c(2, 2))
plot(popultion.model)


# remove the outlier

attach(df1_complete)

# sort by mpg

newdata <- df1_complete %>% arrange(desc(Population))

# drop outlier
newdata = newdata[-1,]

# linear model
popultion.model2 <- lm(Life.expectancy ~Population, data = newdata)

# summary statistics of schooling vs. life expectancy
summary(popultion.model2)

# graph the regession 
p.population2 <- ggplot(newdata, aes(x =  Population , y = Life.expectancy )) +  geom_point() + stat_smooth(method = "lm", col = "red")
ggplotly(p.population2)

# assumptions testing
par(mfrow = c(2, 2))
plot(popultion.model2)

```

#### 8.What is the impact of Immunization coverage on life Expectancy?
Reviewing the graphs, there does not appear to be a significant relationship between life expectancy and immunization.

1. linear regession is not applicable due to the fact that the data doesn't match the required assumptions.
  - Fails constant variance
2. log transformations also did not satisfy the required assumptions for regression
  - Fails constant variance
3. polynomial regression matched the required assumptions with a low R^2 (0.14) and high AIC (920)

```{r}

# 1. LINEAR REGRESSION
    # list of immunizations
    df_immunizations <- df1_complete %>% select("Life.expectancy", "Hepatitis.B", "Polio", "Diphtheria")
    
    # linear model
    immunization.model <- lm(Life.expectancy ~., data = df_immunizations)
    
    # summary statistics of schooling vs. life expectancy
    summary(immunization.model)
    
    # graph the regession 
    require(gridExtra)
    
    p1 <- ggplot(Life_Expectancy_Df_2014, aes(x = Hepatitis.B , y = Life.expectancy )) +  geom_point()
    p2 <- ggplot(Life_Expectancy_Df_2014, aes(x = Polio , y = Life.expectancy )) +  geom_point()
    p3 <- ggplot(Life_Expectancy_Df_2014, aes(x = Diphtheria , y = Life.expectancy )) +  geom_point()
    
    grid.arrange(p1, p2, p3, ncol=2)
    
    # assumptions testing
    
    residual.plots(immunization.model)

# 2. LOG TRANSFORMATIONS
    
    # create logged transformations
    df_immunizations$log.Life.expectancy <- log(df_immunizations$Life.expectancy)
    df_immunizations$log.Hepatitis.B <- log(df_immunizations$Hepatitis.B)
    
    # log-log linear model
    log.immunization.model <- lm(log.Life.expectancy ~log.Hepatitis.B, data = df_immunizations)
    
    # summary statistics
    summary(log.immunization.model)
    
    # graph regression
    ggplot(df_immunizations, aes(x = log.Hepatitis.B , y = log.Life.expectancy )) +  geom_point()
    
    # residual plots
    residual.plots(log.immunization.model)
    
# 3. POLYNOMIAL REGRESSION TESTING
    # linear model
    ploy.immunization.model <- lm(Life.expectancy ~Hepatitis.B+I(Hepatitis.B^2), data = df_immunizations)
    
    # summary statistics
    summary(ploy.immunization.model)
    AIC(ploy.immunization.model)
    BIC(ploy.immunization.model)
    
    # graph regression
    ggplot(df_immunizations, aes(x = Hepatitis.B , y = Life.expectancy )) +  geom_point() + stat_smooth(method = "loess", formula = y ~ x, size = 1) + ggtitle("Life Expectancy vs. Heptatitis B with trend line")
    
    ggplot(df_immunizations, aes(x = Hepatitis.B , y = Life.expectancy )) +  geom_point() + stat_smooth(method = "lm", formula = y ~ x + I(x^2), size = 1) + ggtitle("Life Expectancy vs. Heptatitis B with quadratic regression line")
    
    # residual plots
    residual.plots(ploy.immunization.model)

```



## Objective 1
Display the ability to build regression models using the skills and discussions from Unit 1 and 2 with the purpose of identifying key relationships, interpreting those relationships, and making good predictions.  

*Reminder, key here is to tell a good story.*

### Build  Model 1
  - Identify key relationships
  - Ensure interpretability

Unit 2 Objectives:
- bias vs. variance
- complexity 
- LASSO, LARS, CV (cross validation)

1. Perform regression analysis


- LASSO
Using the lasso regression method, the following were determined to be significant
                          Income.composition.of.resources
While there were other variables that made the model (total expenditure, HIV.AIDs, and BMI), their coefficients are extremely small and not considered to be significant.
```{r}

# LASSO 
    
    ## set the seed to make your partition reproducible
    smp_size <- floor(0.5 * nrow(df1_complete))
    
    set.seed(1234)
    index <- sample(seq_len(nrow(df1_complete)), size = smp_size)
    
    train<-df1_complete[index,]
    test<-df1_complete[-index,]

    
    #Formatting data for GLM net
    x=model.matrix(Life.expectancy~.,train)[,-1]
    y=(train$Life.expectancy)
    
    xtest<-model.matrix(Life.expectancy~.,test)[,-1]
    ytest<-(test$Life.expectancy)
    
    
    grid=10^seq(10,-2, length =100)
    lasso.mod=glmnet(x,y,alpha=1, lambda =grid)
    
    cv.out=cv.glmnet(x,y,alpha=1) #alpha=1 performs LASSO
    plot(cv.out)
    bestlambda<-cv.out$lambda.min  #Optimal penalty parameter.  You can make this call visually.
    lasso.pred=predict(lasso.mod ,s=bestlambda ,newx=xtest)
    
    testMSE_LASSO<-mean((ytest-lasso.pred)^2)
    testMSE_LASSO
    
    coef(lasso.mod,s=bestlambda)
    
    summary(lasso.mod)
  


```
2. Report predictive ability
    a. Test/train set
    b. CV data
```{r}

```

3. Hypothesis Testing
```{r}

```

4. Interpret the coefficients
```{r}

```

5. Confidence intervals
```{r}

```

6. Practical and statistical significance
```{r}

```

### Model 2

    - Product the best predictions as possible
    - Interpretation is no longer required, hence complexity is no longer an issue

1. Feature selection to avoid overfitting

A. Linear Regression
  - model a: linear regression
          life expectancy = 36.55 + 50.73(income)
          Adjusted R^2 = 0.79
  - model b: linear regression + adult mortality
          life expectancy = 48.5 + 38.77(income) - 0.025 (adult mortality)
          Adjusted R^2 = 0.84
  - model c: linear regression + adult mortality + HIV.AIDS
          life expectancy = 49.8 + 36.05 (income) - 0.016 (adult mortality) - 0.95 (HIV/AIDS)
          Adjusted R^2 = 0.85
B. Interaction Terms
  - model d: linear regression + adult mortality + HIV.AIDS
          
```{r}

# Lasso model lasso.mod determined that income the primary predictor for life expectancy
  # SIMPLE MODEL
    simple.model <- lm(Life.expectancy ~Income.composition.of.resources, data = df1_complete)
    # Stepwise regression model
      simple.step.model <- stepAIC(simple.model, direction = "both", 
                        trace = FALSE)
      summary(simple.step.model)
      
  # ADDITION OF VARIABLES MODEL
      # adult mortality
    simple.model <- lm(Life.expectancy ~Income.composition.of.resources + Adult.Mortality , data = df1_complete)
    summary(simple.model)
      
      # Thinness 
    df.expenditure <- df1_complete %>% filter(df1_complete$percentage.expenditure < 100)
    simple.model <- lm(Life.expectancy ~Income.composition.of.resources + Adult.Mortality + Total.expenditure, data = df.expenditure)
    summary(simple.model)
      # AIDS
    simple.model <- lm(Life.expectancy ~Income.composition.of.resources + Adult.Mortality + HIV.AIDS, data = df1_complete)
    summary(simple.model)
    
  # Interaction terms
    simple.model <- lm(Life.expectancy ~Income.composition.of.resources + Adult.Mortality + HIV.AIDS + (Adult.Mortality*HIV.AIDS) + (Income.composition.of.resources*Adult.Mortality) +(Income.composition.of.resources*HIV.AIDS), data = df1_complete)
    summary(simple.model)
    
      
```

2. Create the model

```{r}

```

3. Compare model 1 vs. model 2

```{r}

```

4. Comment on the differences of the models and whether model 2 brings any benefit

```{r}

```


## Objective 2
    - Nonparametric technique
    - kNN or regression trees (select one)

Set of predictors from previous regression: (fill this out)

1.  Model
```{r}


# RANDOM FOREST
# all variables
rf <- randomForest(
  Life.expectancy ~ .,
  data=train
)

varImpPlot(rf)


pred = predict(rf, newdata=test)
pred.df <- as.data.frame(pred)
pred.df$true <- test$Life.expectancy
pred.df$idu <- as.numeric(row.names(pred.df))
ggplot() +  geom_point(data=pred.df, aes(x = idu, y = true ), color='blue')+  geom_point(data=pred.df, aes(x = idu, y = pred ), color='red')

plot(rf)

cm = table(test, pred)
print(rf)

# limited variables !!!!!!!!!!!!!!!!

train %>% select(Adult.Mortality,)

rf <- randomForest(
  Life.expectancy ~ .,
  data=train
)

varImpPlot(rf)

prediction_for_table <- predict(rf_classifier,validation1[,-5])
table(observed=validation1[,5],predicted=prediction_for_table)


pred = predict(rf, newdata=test)
pred.df <- as.data.frame(pred)
pred.df$true <- test$Life.expectancy
pred.df$idu <- as.numeric(row.names(pred.df))
ggplot() +  geom_point(data=pred.df, aes(x = idu, y = true ), color='blue')+  geom_point(data=pred.df, aes(x = idu, y = pred ), color='red')

plot(rf)

cm = table(test[-14], pred)
print(rf)

```

2.	A brief description of your nonparametric model’s strategy to make a prediction.  Include Pros and Cons.
```{r}

```
3.	Provide any additional details that you feel might be necessary to report.
```{r}

```
4.	Report the test ASE using this nonparametric model so we can see how well it does compared to regression.
```{r}

```

# EDA

## Suchi's EDA

```{r}

##############

#1. Does various predicting factors which has been chosen initially really affect the Life expectancy? What are the predicting variables actually affecting the life expectancy?

  #Ploting the available explnatory variables to check co-relation with life expectancy
      ggplot(Life_Expectancy_Df_2014, aes(x = Status , y = Life.expectancy )) +  geom_boxplot()  + xlab("Country's Status ") + ylab("Life Expectancy in Age") +  ggtitle("Distribution of Life Expectancy for Developing vs Developed country")
      ggplot(Life_Expectancy_Df_2014, aes(x = Adult.Mortality, y = Life.expectancy )) +  geom_point()  + xlab("Adult Mortality") + ylab("Life Expectancy in Age")+  ggtitle("Relation between Life Expectancy vs Adult Mortality")
      ggplot(Life_Expectancy_Df_2014, aes(x = infant.deaths, y = Life.expectancy )) +  geom_point()  + xlab("Number of Infant Deaths per 1000 population") + ylab("Life Expectancy in Age")+  ggtitle("Relation between Life Expectancy vs Infant Deaths")
      ggplot(Life_Expectancy_Df_2014, aes(x = Alcohol, y = Life.expectancy )) +  geom_point()  + xlab("Alcohol Consumption") + ylab("Life Expectancy in Age")+  ggtitle("Relation between Life Expectancy vs Alcohol Consumption")
      ggplot(Life_Expectancy_Df_2014, aes(x = percentage.expenditure, y = Life.expectancy )) +  geom_point()  + xlab("Expenditure on health as a percentage of GDP per capita(%)") + ylab("Life Expectancy in Age")+  ggtitle("Relation between Life Expectancy vs Percentage expenditure")
      ggplot(Life_Expectancy_Df_2014, aes(x = Hepatitis.B, y = Life.expectancy )) +  geom_point()  + xlab("Hepatitis B immunization coverage among 1-year-olds (%)") + ylab("Life Expectancy in Age")+  ggtitle("Relation between Life Expectancy vs Hepatitis B immunization")
      ggplot(Life_Expectancy_Df_2014, aes(x = Measles , y = Life.expectancy )) +  geom_point()  + xlab("Number of reported Measles cases per 1000 population") + ylab("Life Expectancy in Age")+  ggtitle("Relation between Life Expectancy vs Measles cases")
      ggplot(Life_Expectancy_Df_2014, aes(x = BMI , y = Life.expectancy )) +  geom_point()  + xlab("BMI") + ylab("Life Expectancy in Age")+  ggtitle("Relation between Life Expectancy vs BMI")
      ggplot(Life_Expectancy_Df_2014, aes(x = under.five.deaths , y = Life.expectancy )) +  geom_point()  + xlab("Number of under-five deaths per 1000 population") + ylab("Life Expectancy in Age")+  ggtitle("Relation between Life Expectancy vs Under Five deaths")
      ggplot(Life_Expectancy_Df_2014, aes(x = Polio, y = Life.expectancy )) +  geom_point()  + xlab("Polio immunization coverage among 1-year-olds (%)") + ylab("Life Expectancy in Age")+  ggtitle("Relation between Life Expectancy vs Polio immunization")
      ggplot(Life_Expectancy_Df_2014, aes(x = Total.expenditure, y = Life.expectancy )) +  geom_point()  + xlab("General Govt expenditure on health as a percentage of total government expenditure") + ylab("Life Expectancy in Age")+  ggtitle("Relation between Life Expectancy vs Total Expenditure")
      ggplot(Life_Expectancy_Df_2014, aes(x = Diphtheria , y = Life.expectancy )) +  geom_point()  + xlab("Diphtheria tetanus toxoid and pertussis (DTP3) immunization coverage among 1-year-olds (%)") + ylab("Life Expectancy in Age")+  ggtitle("Relation between Life Expectancy vs Diphtheria immunization")
      ggplot(Life_Expectancy_Df_2014, aes(x = HIV.AIDS , y = Life.expectancy )) +  geom_point()  + xlab("Deaths per 1000 live births HIV/AIDS (0-4 years)") + ylab("Life Expectancy in Age")+  ggtitle("Relation between Life Expectancy vs HIV deaths")
      ggplot(Life_Expectancy_Df_2014, aes(x = GDP , y = Life.expectancy )) +  geom_point()  + xlab("Gross Domestic Product per capita (in USD)") + ylab("Life Expectancy in Age")+  ggtitle("Relation between Life Expectancy vs GDP")
      ggplot(Life_Expectancy_Df_2014, aes(x = Population , y = Life.expectancy )) +  geom_point()  + xlab("Population of the country") + ylab("Life Expectancy in Age")+  ggtitle("Relation between Life Expectancy vs Population")
      ggplot(Life_Expectancy_Df_2014, aes(x = thinness..1.19.years , y = Life.expectancy )) +  geom_point()  + xlab("Prevalence of thinness among children and adolescents for Age 10-19(%)") + ylab("Life Expectancy in Age")+  ggtitle("Relation between Life Expectancy vs Prevalence of thinness(Age: 10-19)")
      ggplot(Life_Expectancy_Df_2014, aes(x = thinness.5.9.years , y = Life.expectancy )) +  geom_point()  + xlab("Prevalence of thinness among children for Age 5-9(%)") + ylab("Life Expectancy in Age")+  ggtitle("Relation between Life Expectancy vs Prevalence of thinness(Age: 5-9)")
      ggplot(Life_Expectancy_Df_2014, aes(x = Income.composition.of.resources , y = Life.expectancy )) +  geom_point()  + xlab("Human Development Index in terms of income composition of resources") + ylab("Life Expectancy in Age")+  ggtitle("Relation between Life Expectancy vs Income composition)")
      ggplot(Life_Expectancy_Df_2014, aes(x = Schooling , y = Life.expectancy )) +  geom_point()  + xlab("Number of years of Schooling") + ylab("Life Expectancy in Age")+  ggtitle("Relation between Life Expectancy vs Schooling")



##############

#2.Should a country having a lower life expectancy value(<65) increase its healthcare expenditure in order to improve its average lifespan?
#We need to divide the data into 2 categories like >65 and <65 to compare if total expenditure or percentage expenditure has significant impact on life expectancy.

      Life_Expectancy_Df_2014 <- add_column(Life_Expectancy_Df_2014,  Life.expectancy = "Low", .after = "Schooling")
      Life_Expectancy_Df_2014 <- Life_Expectancy_Df_2014 %>% mutate(Life.expectancy.1 = replace(Life.expectancy.1, Life.expectancy >= 65.0, "High"))

      ggplot(Life_Expectancy_Df_2014, aes(x = Life.expectancy.1 , y = Total.expenditure )) +  geom_boxplot()  + xlab("Life Expectancy (More than 65 vs Less than 65) ") + ylab("Govt expenditure on health as a % of total govt expenditure") + ggtitle("Distribution of Healthcare expenditure for low vs high life expectancy") 
      
      ggplot(Life_Expectancy_Df_2014, aes(x = Life.expectancy.1 , y = percentage.expenditure )) +  geom_boxplot()  + xlab("Life Expectancy (More than 65 vs Less than 65) ") + ylab("Expenditure on health as a % of GDP per capita") +  ggtitle("Distribution of Healthcare expenditure for low vs high life expectancy") 


      data_Total.expenditure <- group_by(Life_Expectancy_Df_2014, Life.expectancy.1) %>%
        summarise(
          count = n(),
          mean = mean(Total.expenditure, na.rm = TRUE),
          sd = sd(Total.expenditure, na.rm = TRUE)
        )
      
      summary(data_Total.expenditure)
      
      data_percentage.expenditure <- group_by(Life_Expectancy_Df_2014, Life.expectancy.1) %>%
        summarise(
          count = n(),
          mean = mean(percentage.expenditure, na.rm = TRUE),
          sd = sd(percentage.expenditure, na.rm = TRUE)
        )
      
      summary(data_percentage.expenditure)

 ggqqplot(Life_Expectancy_Df_2014$percentage.expenditure)
 ggqqplot(Life_Expectancy_Df_2014$Total.expenditure)
   
      
  #Equality of variance test for Total.expenditure and percentage.expenditure
      res.ftest <- var.test(Total.expenditure ~ Life.expectancy.1 , data = Life_Expectancy_Df_2014)
      res.ftest

      res.ftest1 <- var.test(percentage.expenditure ~ Life.expectancy.1 , data = Life_Expectancy_Df_2014)
      res.ftest1
      
  #Two Sample T-test / Welch's T-test to find out if the difference we see in EDA actually make sense.
  
    #Two Sample T-test for Total.expenditure variable as there was no significant evidence of differing standard deviation      
        res.total.expenditure <- t.test(Total.expenditure ~ Life.expectancy.1 , data = Life_Expectancy_Df_2014, var.equal = TRUE)
        res.total.expenditure
        
    #Welch's T-test for percentage.expenditure variable as there was significant evidence of differing standard deviation      
        welch.test(percentage.expenditure ~ Life.expectancy.1, Life_Expectancy_Df_2014, rate = 0, alpha = 0.05, na.rm = TRUE, verbose = TRUE)
  

#However I have question on the data. If the definition of percentage expenditure is Expenditure on health as a percentage of Gross Domestic Product per capita(%), then how come it is so high (More than 100%). I do not have domain knowledge. Data suggests that it has impact but is the data accurate? 
      
      
#So I will filter all records where percentage is more than 100 and will fit the model again.
        Life_Expectancy_Df_2014_percentage.expenditure <- Life_Expectancy_Df_2014 %>% filter(percentage.expenditure <  100)  

        data_percentage.expenditure1 <- group_by(Life_Expectancy_Df_2014_percentage.expenditure, Life.expectancy.1) %>%
          summarise(
            count = n(),
            mean = mean(percentage.expenditure, na.rm = TRUE),
            sd = sd(percentage.expenditure, na.rm = TRUE)
          )

        summary(data_percentage.expenditure1)

  # Normality check
        ggqqplot(Life_Expectancy_Df_2014_percentage.expenditure$Total.expenditure) 
      
  # Equality of variance check
        res.ftest2 <- var.test(Total.expenditure ~ Life.expectancy.1 , data = Life_Expectancy_Df_2014_percentage.expenditure) 
        res.ftest2
   
        #Two Sample T-test for Total.expenditure variable(after removing data where percentage value is more than 100) as there was no significant evidence of differing standard deviation      

        res.percentage.expenditure <- t.test(percentage.expenditure ~ Life.expectancy.1, data = Life_Expectancy_Df_2014_percentage.expenditure, var.equal = TRUE)
        res.percentage.expenditure

# We did not get statistically signifcant result. So, this is not related.      
      
        
        
     



##############

#3.How does Infant and Adult mortality rates affect life expectancy?


  #From EDA we can see that infant.deaths is not related to Life.expectancy. Hence fitting the model on Adult.Mortality rate.
      my.model.Adult.Mortality<-lm (Life.expectancy~Adult.Mortality , data = Life_Expectancy_Df_2014 )
      summary(my.model.Adult.Mortality)
      par(mfrow=c(1,2))
      plot(my.model.Adult.Mortality$fitted.values,my.model.Adult.Mortality$residuals,xlab="Fitted Values",ylab="Residuals")
      qqnorm(my.model.Adult.Mortality$residuals)
      qqline(my.model.Adult.Mortality$residuals)

#And from the linear regression model, we can see that Adult mortality rate is negatively related to life expectancy.

##############

#4.Does Life Expectancy has positive or negative correlation with eating habits, lifestyle, exercise, smoking, drinking alcohol etc.


  #We assume that BMI rate is related to lifestyle, eating habits, exercise. Since we see a positive co-relation of BMI with Life Expectancy, we assume that with good eating habits, ample exercice and healthy lifestyle life expectancy would be more.

      my.model.BMI<-lm (Life.expectancy~BMI , data = Life_Expectancy_Df_2014 )
      summary(my.model.BMI)
      par(mfrow=c(1,2))
      plot(my.model.BMI$fitted.values,my.model.BMI$residuals,xlab="Fitted Values",ylab="Residuals")
      qqnorm(my.model.BMI$residuals)
      qqline(my.model.BMI$residuals)


  # Alcohol seems to have positive corelation with life expectancy with a slope of 1.0732.
      my.model.Alcohol<-lm (Life.expectancy~Alcohol , data = Life_Expectancy_Df_2014 )
      summary(my.model.Alcohol)
      par(mfrow=c(1,2))
      plot(my.model.Alcohol$fitted.values,my.model.Alcohol$residuals,xlab="Fitted Values",ylab="Residuals")
      qqnorm(my.model.Alcohol$residuals)
      qqline(my.model.Alcohol$residuals)


##############

```


## Jamie's EDA

---

Linear correlations: 
- Schooling vs Income.composition.of.resource
- thinness..1.19.years vs thinness.5.9.years
- life exp. vs schooling
- life exp. vs income
- infant death vs under 5 death

removed variables that were correlated


```{r}
# print out summary for data
  summary (Life_Expectancy_Df_2014)

# matrix grid to determine correlated variables
  colnames(Life_Expectancy_Df_2014)
  pairs(Life_Expectancy_Df_2014[,c(4:9)])
  pairs(Life_Expectancy_Df_2014[,10:15])
  pairs(Life_Expectancy_Df_2014[,16:22])

# narrowed matrix without correlated variables
  ggpairs(Life_Expectancy_Df_2014[,c(4:5, 7:19, 22)],
        main = "WHO Data",
        pch = 10,
        aes(colour=Life_Expectancy_Df_2014$Status))
```

#### Regression Testing/Variables Reduction

---

Forward, backward, and stepwise regressions were run and all 3 resulted with the same 4 significant variables.

Variables
- Adult.Mortality  
- infant deaths
- Total.expenditure
- HIV.AIDS 
- Income.composition.of.resources


```{r}
# regression selections
  
  # ETL
    # dummy code (developing = 1, developed = 0)
      values <- c(0, 1)
      Life_Expectancy_Df_2014$Status_dc <- values[Life_Expectancy_Df_2014$Status]
      Life_Expectancy_Df_2014_dc <- Life_Expectancy_Df_2014[,c(4:23)]
    # remove nulls
      df1_complete <- na.omit(Life_Expectancy_Df_2014_dc) 
      
  # Fit the full model 
    full.model <- lm(Life.expectancy ~., data = df1_complete)
    # Stepwise regression model
      step.model <- stepAIC(full.model, direction = "both", 
                        trace = FALSE)
      summary(step.model)
    # forward regression model
      foward.model <- stepAIC(full.model, direction = "forward", 
                        trace = FALSE)
      summary(foward.model)
    # backward regression model
      backward.model <- stepAIC(full.model, direction = "backward", 
                        trace = FALSE)
      summary(backward.model)
    
    
```
#### 5.What is the impact of schooling on the lifespan of humans?


```{r}
# linear model
school.model <- lm(Life.expectancy ~Schooling, data = df1_complete)

# summary statistics of schooling vs. life expectancy
summary(school.model)

# graph the regession 
p.school <- ggplot(Life_Expectancy_Df_2014, aes(x =  Schooling , y = Life.expectancy )) +  geom_point() + stat_smooth(method = "lm", col = "red")
ggplotly(p.school)

par(mfrow = c(2, 2))
plot(school.model)

```

#### 6.Does Life Expectancy have positive or negative relationship with drinking alcohol?

Life expectancy has a slight positive increase with alcohol consumption. 
```{r}
# linear model
alcohol.model <- lm(Life.expectancy ~Alcohol, data = df1_complete)

# summary statistics of schooling vs. life expectancy
summary(alcohol.model)

# graph the regession 
p.alcohol <- ggplot(Life_Expectancy_Df_2014, aes(x =  Alcohol , y = Life.expectancy )) +  geom_point() + stat_smooth(method = "lm", col = "red")
ggplotly(p.alcohol)

par(mfrow = c(2, 2))
plot(alcohol.model)

```

#### 7.Do densely populated countries tend to have lower life expectancy?


```{r}

# linear model
popultion.model <- lm(Life.expectancy ~Population, data = df1_complete)

# summary statistics of schooling vs. life expectancy
summary(popultion.model)

# graph the regession 
p.population <- ggplot(Life_Expectancy_Df_2014, aes(x =  Population , y = Life.expectancy )) +  geom_point() + stat_smooth(method = "lm", col = "red")
ggplotly(p.population)

# assumptions testing
par(mfrow = c(2, 2))
plot(popultion.model)


# remove the outlier

attach(df1_complete)

# sort by mpg

newdata <- df1_complete %>% arrange(desc(Population))

# drop outlier
newdata = newdata[-1,]

# linear model
popultion.model2 <- lm(Life.expectancy ~Population, data = newdata)

# summary statistics of schooling vs. life expectancy
summary(popultion.model2)

# graph the regession 
p.population2 <- ggplot(newdata, aes(x =  Population , y = Life.expectancy )) +  geom_point() + stat_smooth(method = "lm", col = "red")
ggplotly(p.population2)

# assumptions testing
par(mfrow = c(2, 2))
plot(popultion.model2)

```

#### 8.What is the impact of Immunization coverage on life Expectancy?

Reviewing the graphs, there does not appear to be a significant relationship between life expectancy and immunization.

!!! Testing !!!
- interaction terms
- awknowledge polio significance

```{r}

# list of immunizations
df_immunizations <- df1_complete %>% select("Life.expectancy", "Hepatitis.B", "Polio", "Diphtheria")
df_immunizations$log.Hepatitis.B = log(df_immunizations$Hepatitis.B)
df_immunizations$log.Life.expectancy = log(df_immunizations$Life.expectancy)

# linear model
immunization.model <- lm(log.Life.expectancy ~log.Hepatitis.B, data = df_immunizations)

# summary statistics of schooling vs. life expectancy
summary(immunization.model)

# graph the regession 
require(gridExtra)

p1 <- ggplot(df_immunizations, aes(x = log.Hepatitis.B , y = log.Life.expectancy )) +  geom_point()
p2 <- ggplot(Life_Expectancy_Df_2014, aes(x = Polio , y = Life.expectancy )) +  geom_point()
p4 <- ggplot(Life_Expectancy_Df_2014, aes(x = Diphtheria , y = Life.expectancy )) +  geom_point()

grid.arrange(p1, p2, p4, ncol=2)


# assumptions testing
par(mfrow = c(2, 2))
plot(immunization.model)



```


